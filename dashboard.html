<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFind - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Montserrat:400,800');

        body {
            background: #e0f2f1;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .dashboard-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 14px 28px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
            width: 100%;
            max-width: 450px;
        }

        .brand-logo {
            font-size: 2rem;
            color: #0d47a1;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .brand-logo span { color: #42a5f5; }

        .user-info {
            margin: 15px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            text-align: left;
        }

        h2 { color: #0d47a1; margin: 0 0 5px 0; font-size: 1.2rem; }
        p { color: #546e7a; margin: 3px 0; font-size: 0.9rem; }

        /* Form Styling */
        .profile-form {
            display: none; /* Hidden until data loads */
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        input, textarea {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            border-radius: 5px;
            font-family: inherit;
            box-sizing: border-box;
        }

        button {
            border-radius: 20px;
            border: 1px solid #0d47a1;
            background-color: #0d47a1;
            color: #FFFFFF;
            font-size: 11px;
            font-weight: bold;
            padding: 10px 30px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 80ms ease-in;
            margin-top: 10px;
        }

        button:active { transform: scale(0.95); }
        .btn-secondary { background-color: #546e7a; border-color: #546e7a; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="dashboard-card">
        <div class="brand-logo">Stay<span>Find</span></div>
        <h1 style="font-size: 1.5rem;">Dashboard</h1>
        
        <div id="content">
            <div class="loader" style="margin: 20px auto;"></div>
            <p>Fetching your profile...</p>
        </div>

        <div id="profileFormSection" class="profile-form">
            <h3 style="color: #0d47a1; margin-bottom: 10px;">Update Profile</h3>
            <input type="text" id="userPhone" placeholder="Phone Number">
            <input type="text" id="userAddress" placeholder="Address">
            <textarea id="userBio" placeholder="Tell us about yourself..." rows="3"></textarea>
            <button id="saveProfileBtn">Save Profile</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <button id="logoutBtn" class="btn-secondary">Sign Out</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7v_LWg5_I_Y_m-iUIWa09cade8JTkgHk",
        authDomain: "stayfind-f7a28.firebaseapp.com",
        projectId: "stayfind-f7a28",
        databaseURL: "https://stayfind-f7a28-default-rtdb.firebaseio.com",
        storageBucket: "stayfind-f7a28.firebasestorage.app",
        messagingSenderId: "682175949982",
        appId: "1:682175949982:web:e05561d627caaf3d5d5f8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const contentDiv = document.getElementById('content');
    const profileFormSection = document.getElementById('profileFormSection');

    // Monitor Auth State
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = ref(db, 'users/' + user.uid);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                
                // Display current info
                contentDiv.innerHTML = `
                    <div class="user-info">
                        <h2>Welcome, ${userData.displayName || 'Guest'}</h2>
                        <p><i class="fas fa-envelope"></i> ${userData.email}</p>
                        <p><i class="fas fa-phone"></i> ${userData.phone || 'No phone added'}</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${userData.address || 'No address added'}</p>
                    </div>
                `;

                // Fill form fields with existing data
                document.getElementById('userPhone').value = userData.phone || "";
                document.getElementById('userAddress').value = userData.address || "";
                document.getElementById('userBio').value = userData.bio || "";
                
                // Show form
                profileFormSection.style.display = 'block';
            } else {
                contentDiv.innerHTML = `<p>No profile data found.</p>`;
            }
        } else {
            window.location.href = "index.html"; 
        }
    });

    // Save Profile Logic
    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;

        const updates = {
            phone: document.getElementById('userPhone').value,
            address: document.getElementById('userAddress').value,
            bio: document.getElementById('userBio').value
        };

        try {
            await update(ref(db, 'users/' + user.uid), updates);
            alert("Profile updated successfully!");
            location.reload(); // Refresh to show new data in the top card
        } catch (error) {
            alert("Update failed: " + error.message);
        }
    });

    // Logout Function
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = "index.html";
        }).catch((error) => {
            alert("Error signing out: " + error.message);
        });
    });
</script>
</body>
</html>